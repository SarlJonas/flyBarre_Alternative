<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>flyBarre - Scanner Professionnel Hybride</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #00D4FF;
            --secondary: #0080FF;
            --success: #00FF88;
            --danger: #FF3D00;
            --warning: #FFA500;
            --dark: #0A0E1A;
            --dark-2: #131B2E;
            --dark-3: #1A2942;
            --text: #FFFFFF;
            --text-2: #A0B8E0;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--dark);
            color: var(--text);
            min-height: 100vh;
        }

        .header {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            padding: 20px 30px;
            box-shadow: 0 4px 20px rgba(0, 212, 255, 0.3);
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo-icon svg {
            width: 50px;
            height: 50px;
        }

        .logo-text h1 {
            font-size: 2.5rem;
            color: var(--dark);
            font-family: 'Bebas Neue', sans-serif;
        }

        .logo-highlight {
            color: var(--secondary);
        }

        .version-badge {
            background: var(--dark);
            color: var(--primary);
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 30px 20px;
        }

        .mode-tabs {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            background: var(--dark-2);
            padding: 10px;
            border-radius: 15px;
        }

        .tab-btn {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            background: transparent;
            color: var(--text-2);
        }

        .tab-btn.active {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: var(--dark);
        }

        .mode-content {
            display: none;
        }

        .mode-content.active {
            display: block;
        }

        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .btn {
            padding: 15px 25px;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .btn-primary {
            background: var(--primary);
            color: var(--dark);
        }

        .btn-primary:hover {
            background: var(--secondary);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 212, 255, 0.4);
        }

        .btn-success {
            background: var(--success);
            color: var(--dark);
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-warning {
            background: var(--warning);
            color: var(--dark);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .camera-section {
            background: var(--dark-2);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            border: 2px solid var(--dark-3);
        }

        #videoElement {
            width: 100%;
            max-width: 800px;
            margin: 0 auto;
            display: block;
            border-radius: 10px;
            background: #000;
        }

        .upload-zone {
            background: var(--dark-2);
            border: 3px dashed var(--primary);
            border-radius: 15px;
            padding: 60px 40px;
            text-align: center;
            margin-bottom: 30px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .upload-zone:hover {
            background: var(--dark-3);
            border-color: var(--success);
        }

        .upload-zone.dragover {
            background: var(--dark-3);
            border-color: var(--success);
            transform: scale(1.02);
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--dark-2);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            border: 2px solid var(--dark-3);
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: bold;
            color: var(--primary);
            margin-bottom: 5px;
        }

        .stat-label {
            color: var(--text-2);
            font-size: 0.9rem;
        }

        .table-section {
            background: var(--dark-2);
            border-radius: 15px;
            overflow-x: auto;
            border: 2px solid var(--dark-3);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background: var(--dark-3);
            padding: 15px;
            text-align: left;
            font-weight: 600;
            color: var(--primary);
            white-space: nowrap;
        }

        td {
            padding: 15px;
            border-top: 1px solid var(--dark-3);
        }

        tr:hover {
            background: var(--dark-3);
        }

        .product-count {
            background: var(--primary);
            color: var(--dark);
            padding: 5px 12px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.9rem;
        }

        .badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 0.85rem;
            font-weight: 600;
            background: var(--primary);
            color: var(--dark);
        }

        .btn-delete {
            background: var(--danger);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.85rem;
        }

        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
        }

        .toast {
            background: var(--dark-2);
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            border-left: 4px solid var(--success);
            min-width: 300px;
            animation: slideIn 0.3s ease;
        }

        .toast.error {
            border-left-color: var(--danger);
        }

        .toast.warning {
            border-left-color: var(--warning);
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .footer {
            text-align: center;
            padding: 30px;
            color: var(--text-2);
            margin-top: 50px;
            border-top: 2px solid var(--dark-3);
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-2);
        }

        .scanning-indicator {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 212, 255, 0.9);
            color: var(--dark);
            padding: 15px 30px;
            border-radius: 10px;
            font-weight: bold;
            font-size: 1.2rem;
            animation: pulse 1.5s infinite;
            z-index: 10;
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.8; transform: translate(-50%, -50%) scale(1); }
            50% { opacity: 1; transform: translate(-50%, -50%) scale(1.05); }
        }

        #fileInput {
            display: none;
        }

        .progress-bar {
            width: 100%;
            height: 30px;
            background: var(--dark-3);
            border-radius: 15px;
            overflow: hidden;
            margin: 20px 0;
            display: none;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--success));
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--dark);
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <div class="logo">
                <div class="logo-icon">
                    <svg width="50" height="50" viewBox="0 0 50 50" fill="none">
                        <rect x="2" y="10" width="3" height="30" fill="#0A0E1A" opacity="0.9"/>
                        <rect x="7" y="10" width="3" height="30" fill="#0A0E1A" opacity="0.8"/>
                        <rect x="12" y="10" width="3" height="30" fill="#0A0E1A" opacity="0.9"/>
                        <rect x="17" y="10" width="3" height="30" fill="#0A0E1A" opacity="0.7"/>
                        <rect x="22" y="10" width="3" height="30" fill="#0A0E1A" opacity="0.9"/>
                        <rect x="27" y="10" width="3" height="30" fill="#0A0E1A" opacity="0.8"/>
                        <rect x="32" y="10" width="3" height="30" fill="#0A0E1A" opacity="0.9"/>
                        <rect x="37" y="10" width="3" height="30" fill="#0A0E1A" opacity="0.7"/>
                        <line x1="0" y1="25" x2="45" y2="20" stroke="#0A0E1A" stroke-width="2" opacity="0.6"/>
                    </svg>
                </div>
                <div class="logo-text">
                    <h1>fly<span class="logo-highlight">Barre</span></h1>
                </div>
            </div>
            <div class="version-badge">
                üöÄ v5.0 HYBRIDE PRO
            </div>
        </div>
    </div>

    <div class="container">
        <div class="mode-tabs">
            <button class="tab-btn active" data-mode="camera">
                üìπ Mode Cam√©ra
            </button>
            <button class="tab-btn" data-mode="upload">
                üìÅ Mode Upload
            </button>
        </div>

        <!-- MODE CAMERA -->
        <div id="cameraMode" class="mode-content active">
            <div class="controls">
                <button id="startCameraBtn" class="btn btn-primary">
                    üìπ D√©marrer Cam√©ra
                </button>
                <button id="stopCameraBtn" class="btn btn-danger" disabled>
                    ‚èπ Arr√™ter
                </button>
            </div>
            
            <div class="camera-section" style="position: relative;">
                <video id="videoElement" autoplay playsinline></video>
                <canvas id="canvasElement" style="display: none;"></canvas>
                <div id="scanningIndicator" class="scanning-indicator" style="display: none;">
                    üîç Scan en cours...
                </div>
            </div>
        </div>

        <!-- MODE UPLOAD -->
        <div id="uploadMode" class="mode-content">
            <div class="upload-zone" id="uploadZone">
                <div style="font-size: 4rem; margin-bottom: 20px;">üì§</div>
                <div style="font-size: 1.3rem; margin-bottom: 10px; color: var(--primary);">
                    Cliquez ou glissez des images
                </div>
                <div style="color: var(--text-2); font-size: 0.95rem;">
                    Formats: JPG, PNG, PDF | D√©tection en masse support√©e
                </div>
                <input type="file" id="fileInput" accept="image/*,.pdf" multiple>
            </div>

            <div class="progress-bar" id="progressBar">
                <div class="progress-fill" id="progressFill">0%</div>
            </div>
        </div>

        <!-- CONTROLS COMMUNS -->
        <div class="controls">
            <button id="exportExcelBtn" class="btn btn-success">
                üì• Exporter Excel
            </button>
            <button id="exportPdfBtn" class="btn btn-warning">
                üìÑ Rapport PDF
            </button>
            <button id="saveDatabaseBtn" class="btn btn-primary">
                üíæ Sauvegarder BDD
            </button>
            <button id="clearBtn" class="btn btn-danger">
                üóë Effacer Tout
            </button>
        </div>

        <!-- STATS -->
        <div class="stats">
            <div class="stat-card">
                <div class="stat-value" id="totalScans">0</div>
                <div class="stat-label">Total Scans</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="uniqueProducts">0</div>
                <div class="stat-label">Produits Uniques</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="totalItems">0</div>
                <div class="stat-label">Articles Total</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="successRate">0%</div>
                <div class="stat-label">Taux D√©tection</div>
            </div>
        </div>

        <!-- TABLE -->
        <div class="table-section">
            <table>
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Code-Barre</th>
                        <th>Produit</th>
                        <th>Marque</th>
                        <th>Quantit√©</th>
                        <th>Type</th>
                        <th>Dernier Scan</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                    <tr class="empty-state">
                        <td colspan="8">
                            <p style="font-size: 1.2rem; margin-bottom: 10px;">Aucun produit scann√©</p>
                            <p>Choisissez un mode et commencez √† scanner</p>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- FOOTER -->
        <div class="footer">
            <p style="font-size: 1.2rem; margin-bottom: 10px;"><strong>SARL Jonas Browser High-Tech</strong></p>
            <p>üìç 108 BVD Robert Schuman, 44300</p>
            <p>üì± 06 52 57 37 79 | üìß jonas-browser@outlook.fr</p>
            <p style="margin-top: 15px; color: var(--primary);">¬© 2026 flyBarre PRO - Tous droits r√©serv√©s</p>
        </div>
    </div>

    <div id="toastContainer" class="toast-container"></div>

    <!-- LIBRARIES -->
    <script src="https://unpkg.com/@zxing/library@0.20.0/umd/index.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/quagga@0.12.1/dist/quagga.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    
    <script>
        // √âtat global
        const state = {
            products: new Map(),
            currentMode: 'camera',
            isScanning: false,
            stream: null,
            detectionMethods: [],
            totalAttempts: 0,
            successfulScans: 0
        };

        const elements = {
            startCameraBtn: document.getElementById('startCameraBtn'),
            stopCameraBtn: document.getElementById('stopCameraBtn'),
            videoElement: document.getElementById('videoElement'),
            canvasElement: document.getElementById('canvasElement'),
            scanningIndicator: document.getElementById('scanningIndicator'),
            uploadZone: document.getElementById('uploadZone'),
            fileInput: document.getElementById('fileInput'),
            progressBar: document.getElementById('progressBar'),
            progressFill: document.getElementById('progressFill'),
            exportExcelBtn: document.getElementById('exportExcelBtn'),
            exportPdfBtn: document.getElementById('exportPdfBtn'),
            saveDatabaseBtn: document.getElementById('saveDatabaseBtn'),
            clearBtn: document.getElementById('clearBtn'),
            tableBody: document.getElementById('tableBody'),
            totalScans: document.getElementById('totalScans'),
            uniqueProducts: document.getElementById('uniqueProducts'),
            totalItems: document.getElementById('totalItems'),
            successRate: document.getElementById('successRate'),
            toastContainer: document.getElementById('toastContainer')
        };

        // ========================================
        // MODE SWITCHING
        // ========================================

        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const mode = btn.dataset.mode;
                
                // Update tabs
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                
                // Update content
                document.querySelectorAll('.mode-content').forEach(c => c.classList.remove('active'));
                document.getElementById(mode + 'Mode').classList.add('active');
                
                state.currentMode = mode;
                
                // Stop camera if switching away
                if (mode !== 'camera' && state.isScanning) {
                    stopCamera();
                }
            });
        });

        // ========================================
        // CAMERA MODE - MULTI-DETECTOR
        // ========================================

        async function startCamera() {
            try {
                showToast('info', 'D√©marrage cam√©ra...');
                
                const constraints = {
                    video: {
                        facingMode: 'environment',
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    }
                };
                
                state.stream = await navigator.mediaDevices.getUserMedia(constraints);
                elements.videoElement.srcObject = state.stream;
                
                await new Promise(resolve => {
                    elements.videoElement.onloadedmetadata = resolve;
                });
                
                state.isScanning = true;
                elements.startCameraBtn.disabled = true;
                elements.stopCameraBtn.disabled = false;
                elements.scanningIndicator.style.display = 'block';
                
                showToast('success', '‚úÖ Cam√©ra d√©marr√©e');
                
                // Start continuous scanning
                scanContinuously();
                
            } catch (error) {
                console.error('Camera error:', error);
                showToast('error', 'Erreur cam√©ra: ' + error.message);
            }
        }

        function stopCamera() {
            if (state.stream) {
                state.stream.getTracks().forEach(track => track.stop());
                state.stream = null;
            }
            
            state.isScanning = false;
            elements.startCameraBtn.disabled = false;
            elements.stopCameraBtn.disabled = true;
            elements.scanningIndicator.style.display = 'none';
            elements.videoElement.srcObject = null;
            
            showToast('success', 'Cam√©ra arr√™t√©e');
        }

        async function scanContinuously() {
            while (state.isScanning) {
                await captureAndAnalyze();
                await new Promise(resolve => setTimeout(resolve, 500)); // Scan every 500ms
            }
        }

        async function captureAndAnalyze() {
            try {
                const canvas = elements.canvasElement;
                const video = elements.videoElement;
                
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                
                const ctx = canvas.getContext('2d');
                ctx.drawImage(video, 0, 0);
                
                state.totalAttempts++;
                
                // Try MULTIPLE detectors in parallel for better success rate
                const detectors = [
                    detectWithZXing(canvas),
                    detectWithQuagga(canvas)
                ];
                
                const results = await Promise.allSettled(detectors);
                
                for (const result of results) {
                    if (result.status === 'fulfilled' && result.value) {
                        handleBarcodeDetected(result.value.code, result.value.format, 'camera');
                        state.successfulScans++;
                        updateSuccessRate();
                        break; // Stop after first successful detection
                    }
                }
                
            } catch (error) {
                // Silent error, continue scanning
            }
        }

        // ========================================
        // DETECTION METHODS
        // ========================================

        async function detectWithZXing(canvas) {
            try {
                const codeReader = new ZXing.BrowserMultiFormatReader();
                const result = await codeReader.decodeFromCanvas(canvas);
                
                if (result && result.text) {
                    return {
                        code: result.text,
                        format: result.format || 'UNKNOWN'
                    };
                }
            } catch (error) {
                // Continue to next detector
            }
            return null;
        }

        async function detectWithQuagga(canvas) {
            return new Promise((resolve) => {
                try {
                    const ctx = canvas.getContext('2d');
                    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                    
                    Quagga.decodeSingle({
                        decoder: {
                            readers: [
                                "code_128_reader",
                                "ean_reader",
                                "ean_8_reader",
                                "code_39_reader",
                                "code_39_vin_reader",
                                "codabar_reader",
                                "upc_reader",
                                "upc_e_reader",
                                "i2of5_reader"
                            ]
                        },
                        locate: true,
                        src: canvas.toDataURL()
                    }, (result) => {
                        if (result && result.codeResult) {
                            resolve({
                                code: result.codeResult.code,
                                format: result.codeResult.format
                            });
                        } else {
                            resolve(null);
                        }
                    });
                } catch (error) {
                    resolve(null);
                }
            });
        }

        // ========================================
        // UPLOAD MODE
        // ========================================

        elements.uploadZone.addEventListener('click', () => elements.fileInput.click());

        elements.fileInput.addEventListener('change', (e) => {
            handleFiles(e.target.files);
        });

        elements.uploadZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            elements.uploadZone.classList.add('dragover');
        });

        elements.uploadZone.addEventListener('dragleave', () => {
            elements.uploadZone.classList.remove('dragover');
        });

        elements.uploadZone.addEventListener('drop', (e) => {
            e.preventDefault();
            elements.uploadZone.classList.remove('dragover');
            handleFiles(e.dataTransfer.files);
        });

        async function handleFiles(files) {
            const fileArray = Array.from(files);
            const total = fileArray.length;
            
            showToast('info', `Traitement de ${total} fichier(s)...`);
            elements.progressBar.style.display = 'block';
            
            for (let i = 0; i < fileArray.length; i++) {
                const file = fileArray[i];
                const progress = ((i + 1) / total * 100).toFixed(0);
                
                elements.progressFill.style.width = progress + '%';
                elements.progressFill.textContent = progress + '%';
                
                if (file.type.startsWith('image/')) {
                    await processImageFile(file);
                }
                
                await new Promise(resolve => setTimeout(resolve, 100)); // Small delay
            }
            
            elements.progressBar.style.display = 'none';
            showToast('success', `‚úÖ ${total} fichier(s) trait√©(s)`);
        }

        async function processImageFile(file) {
            try {
                state.totalAttempts++;
                
                const img = new Image();
                img.src = URL.createObjectURL(file);
                await new Promise((resolve) => img.onload = resolve);
                
                // Create canvas
                const canvas = document.createElement('canvas');
                canvas.width = img.width;
                canvas.height = img.height;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0);
                
                // Try multiple detectors
                const detectors = [
                    detectWithZXing(canvas),
                    detectWithQuagga(canvas)
                ];
                
                const results = await Promise.allSettled(detectors);
                
                for (const result of results) {
                    if (result.status === 'fulfilled' && result.value) {
                        handleBarcodeDetected(result.value.code, result.value.format, 'upload');
                        state.successfulScans++;
                        updateSuccessRate();
                        return;
                    }
                }
                
                // No code detected
                console.log('No code in:', file.name);
                
            } catch (error) {
                console.error('Error processing:', file.name, error);
            }
        }

        // ========================================
        // BARCODE HANDLING
        // ========================================

        async function handleBarcodeDetected(barcode, format, source) {
            if (state.products.has(barcode)) {
                const product = state.products.get(barcode);
                product.count++;
                product.lastScan = new Date().toLocaleString('fr-FR');
            } else {
                state.products.set(barcode, {
                    code: barcode,
                    name: 'Recherche...',
                    brand: '-',
                    count: 1,
                    type: format,
                    lastScan: new Date().toLocaleString('fr-FR'),
                    source: source
                });
                
                fetchProductInfo(barcode);
            }
            
            updateTable();
            updateStats();
            saveData();
            playBeep();
            
            const product = state.products.get(barcode);
            showToast('success', `‚úÖ ${product.name} (x${product.count})`);
        }

        async function fetchProductInfo(barcode) {
            try {
                const response = await fetch(`https://world.openfoodfacts.org/api/v0/product/${barcode}.json`);
                const data = await response.json();
                
                if (data.status === 1 && state.products.has(barcode)) {
                    const product = state.products.get(barcode);
                    product.name = data.product.product_name || 'Produit ' + barcode;
                    product.brand = data.product.brands || '-';
                    updateTable();
                    saveData();
                } else if (state.products.has(barcode)) {
                    const product = state.products.get(barcode);
                    product.name = 'Produit ' + barcode;
                    updateTable();
                }
            } catch (error) {
                if (state.products.has(barcode)) {
                    const product = state.products.get(barcode);
                    product.name = 'Produit ' + barcode;
                    updateTable();
                }
            }
        }

        // ========================================
        // UI UPDATES
        // ========================================

        function updateTable() {
            if (state.products.size === 0) {
                elements.tableBody.innerHTML = `
                    <tr class="empty-state">
                        <td colspan="8"><p>Aucun produit scann√©</p></td>
                    </tr>
                `;
                return;
            }
            
            const productsArray = Array.from(state.products.values());
            productsArray.sort((a, b) => new Date(b.lastScan) - new Date(a.lastScan));
            
            elements.tableBody.innerHTML = productsArray.map((p, i) => `
                <tr>
                    <td>${i + 1}</td>
                    <td><strong>${p.code}</strong></td>
                    <td>${p.name}</td>
                    <td>${p.brand}</td>
                    <td><span class="product-count">x${p.count}</span></td>
                    <td><span class="badge">${p.type}</span></td>
                    <td>${p.lastScan}</td>
                    <td><button class="btn-delete" onclick="deleteProduct('${p.code}')">Supprimer</button></td>
                </tr>
            `).join('');
        }

        function updateStats() {
            const totalScans = Array.from(state.products.values()).reduce((sum, p) => sum + p.count, 0);
            elements.totalScans.textContent = totalScans;
            elements.uniqueProducts.textContent = state.products.size;
            elements.totalItems.textContent = totalScans;
        }

        function updateSuccessRate() {
            const rate = state.totalAttempts > 0 
                ? ((state.successfulScans / state.totalAttempts) * 100).toFixed(1)
                : 0;
            elements.successRate.textContent = rate + '%';
        }

        // ========================================
        // EXPORT FUNCTIONS
        // ========================================

        function exportToExcel() {
            if (state.products.size === 0) {
                showToast('warning', 'Aucune donn√©e √† exporter');
                return;
            }
            
            const data = Array.from(state.products.values()).map((p, i) => ({
                '#': i + 1,
                'Code-Barre': p.code,
                'Produit': p.name,
                'Marque': p.brand,
                'Quantit√©': p.count,
                'Type': p.type,
                'Dernier Scan': p.lastScan
            }));
            
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet(data);
            ws['!cols'] = [
                { wch: 5 }, { wch: 20 }, { wch: 35 }, { wch: 20 },
                { wch: 10 }, { wch: 15 }, { wch: 20 }
            ];
            XLSX.utils.book_append_sheet(wb, ws, 'Inventaire');
            XLSX.writeFile(wb, `flyBarre_inventaire_${Date.now()}.xlsx`);
            
            showToast('success', 'üì• Excel t√©l√©charg√©!');
        }

        function exportToPDF() {
            if (state.products.size === 0) {
                showToast('warning', 'Aucune donn√©e √† exporter');
                return;
            }
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // En-t√™te
            doc.setFontSize(20);
            doc.text('flyBarre - Rapport d\'Inventaire', 14, 22);
            
            doc.setFontSize(12);
            doc.text(`Date: ${new Date().toLocaleString('fr-FR')}`, 14, 32);
            doc.text(`SARL Jonas Browser High-Tech`, 14, 40);
            
            // Stats
            const totalScans = Array.from(state.products.values()).reduce((sum, p) => sum + p.count, 0);
            doc.text(`Total Scans: ${totalScans}`, 14, 50);
            doc.text(`Produits Uniques: ${state.products.size}`, 14, 58);
            doc.text(`Taux D√©tection: ${elements.successRate.textContent}`, 14, 66);
            
            // Tableau
            const tableData = Array.from(state.products.values()).map((p, i) => [
                i + 1,
                p.code,
                p.name,
                p.brand,
                p.count,
                p.type,
                p.lastScan
            ]);
            
            doc.autoTable({
                head: [['#', 'Code', 'Produit', 'Marque', 'Qt√©', 'Type', 'Date']],
                body: tableData,
                startY: 75,
                styles: { fontSize: 8 }
            });
            
            doc.save(`flyBarre_rapport_${Date.now()}.pdf`);
            
            showToast('success', 'üìÑ PDF t√©l√©charg√©!');
        }

        function saveToDatabase() {
            const data = {
                timestamp: new Date().toISOString(),
                products: Array.from(state.products.entries()),
                stats: {
                    totalScans: Array.from(state.products.values()).reduce((sum, p) => sum + p.count, 0),
                    uniqueProducts: state.products.size,
                    successRate: elements.successRate.textContent
                }
            };
            
            localStorage.setItem('flyBarre_database', JSON.stringify(data));
            showToast('success', 'üíæ Sauvegard√© dans la base de donn√©es locale');
        }

        // ========================================
        // DATA MANAGEMENT
        // ========================================

        function saveData() {
            localStorage.setItem('flyBarre_products', JSON.stringify(Array.from(state.products.entries())));
        }

        function loadData() {
            const saved = localStorage.getItem('flyBarre_products');
            if (saved) {
                state.products = new Map(JSON.parse(saved));
                updateTable();
                updateStats();
            }
        }

        function deleteProduct(code) {
            state.products.delete(code);
            updateTable();
            updateStats();
            saveData();
            showToast('success', 'Produit supprim√©');
        }

        window.deleteProduct = deleteProduct;

        function clearAllData() {
            if (state.products.size === 0) return;
            if (confirm(`Effacer ${state.products.size} produits?`)) {
                state.products.clear();
                updateTable();
                updateStats();
                saveData();
                showToast('success', 'Donn√©es effac√©es');
            }
        }

        // ========================================
        // UTILITIES
        // ========================================

        function showToast(type, message) {
            const toast = document.createElement('div');
            toast.className = 'toast ' + type;
            toast.textContent = message;
            elements.toastContainer.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        function playBeep() {
            try {
                const ctx = new (window.AudioContext || window.webkitAudioContext)();
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                osc.connect(gain);
                gain.connect(ctx.destination);
                osc.frequency.value = 880;
                osc.type = 'sine';
                gain.gain.setValueAtTime(0.3, ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.1);
                osc.start(ctx.currentTime);
                osc.stop(ctx.currentTime + 0.1);
            } catch (e) {}
        }

        // ========================================
        // EVENT LISTENERS
        // ========================================

        elements.startCameraBtn.addEventListener('click', startCamera);
        elements.stopCameraBtn.addEventListener('click', stopCamera);
        elements.exportExcelBtn.addEventListener('click', exportToExcel);
        elements.exportPdfBtn.addEventListener('click', exportToPDF);
        elements.saveDatabaseBtn.addEventListener('click', saveToDatabase);
        elements.clearBtn.addEventListener('click', clearAllData);

        // ========================================
        // INIT
        // ========================================

        window.addEventListener('DOMContentLoaded', () => {
            console.log('üöÄ flyBarre v5.0 HYBRIDE PRO');
            console.log('üì± Jonas Browser High-Tech');
            loadData();
            showToast('success', 'Application pr√™te! Choisissez un mode.');
        });
    </script>
</body>
</html>
